<div id="bg" class="surface-ground min-h-screen p-2 md:p-4">
  <div  class="max-w-7xl mx-auto">
    
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <p-toolbar class="mb-3 md:mb-4">
      <ng-template pTemplate="left">
        <div class="flex align-items-center gap-2 md:gap-3">
          <div>
            <h1 class="text-xl md:text-3xl font-bold m-0">Diário de Bordo</h1>
            <p class="text-xs md:text-sm text-color-secondary m-0 hidden sm:block"></p>
          </div>
        </div>
      </ng-template>
      <ng-template pTemplate="right">
        <p-button 
          [label]="isLargeScreen() ? 'Novo Registro' : ''" 
          icon="pi pi-plus" 
          (onClick)="openDialog()"
          severity="success"
          [iconPos]="isLargeScreen() ? 'left' : 'left'"
          styleClass="p-button-sm md:p-button">
        </p-button>
      </ng-template>
    </p-toolbar>

    <p-card id="container"  class="mb-3 md:mb-4">
      <div  class="grid gap-2">
        <div class="col-12 lg:col-8">
          <span class="p-input-icon-left w-full">
            <i class="pi pi-search"></i>
            <input 
              pInputText 
              type="text" 
              placeholder="Pesquisar..."
              [(ngModel)]="searchTerm"
              (ngModelChange)="searchTerm.set($event)"
              class="w-full text-sm md:text-base">
          </span>
        </div>
        <div class="col-12 lg:col-4">
          <p-dropdown 
            [options]="tagOptions" 
            [(ngModel)]="selectedTag"
            placeholder="Filtrar por tag"
            optionLabel="label"
            optionValue="value"
            [showClear]="true"
            styleClass="w-full text-sm md:text-base">
          </p-dropdown>
        </div>
      </div>
    </p-card>

    <p-dialog 
  [header]="editingId() ? 'Editar' : 'Novo Registro'"
  [(visible)]="displayDialog"
  [modal]="true"
  [breakpoints]="{'960px': '90vw', '640px': '95vw'}"
  [style]="{width: '600px'}" 
  [draggable]="false"
  [resizable]="false"
  (onHide)="closeDialog()">

  <div class="p-fluid grid formgrid p-2">
    
    <div class="field col-12 mb-3">
      <label for="title" class="font-bold block mb-2">Título do Experimento: </label>
      <input 
        id="title"
        pInputText 
        [(ngModel)]="newEntry().title"
        (ngModelChange)="updateField('title', $event)"
        placeholder="Ex: Reação de Vulcão Químico">
    </div>

    <div class="field col-12 mb-3">
      <label for="date" class="font-bold block mb-2">Data</label>
      <p-calendar 
        id="date"
        [(ngModel)]="newEntry().date"
        (ngModelChange)="updateField('date', $event)"
        dateFormat="dd/mm/yy"
        [showIcon]="true"
        [touchUI]="isMobile()"
        appendTo="body">
      </p-calendar>
    </div>

    <div class="field col-12 mb-3">
      <label for="materials" class="font-bold block mb-2">Materiais Utilizados: </label>
      <textarea 
        id="materials"
        pInputTextarea
        [(ngModel)]="newEntry().materials"
        (ngModelChange)="updateField('materials', $event)"
        [rows]="2"
        [autoResize]="true"
        placeholder="Bicarbonato de sódio, vinagre, corante...">
      </textarea>
    </div>

    <div class="field col-12 mb-3">
      <label for="content" class="font-bold block mb-2">Procedimento e Resultados: </label>
      <textarea 
        id="content"
        pInputTextarea
        [(ngModel)]="newEntry().content"
        (ngModelChange)="updateField('content', $event)"
        [rows]="5"
        [autoResize]="true"
        placeholder="Descreva o procedimento realizado...">
      </textarea>
    </div>

    <div class="field col-12 mb-3">
      <label for="observations" class="font-bold block mb-2">Observações e Conclusões: </label>
      <textarea 
        id="observations"
        pInputTextarea
        [(ngModel)]="newEntry().observations"
        (ngModelChange)="updateField('observations', $event)"
        [rows]="3"
        [autoResize]="true"
        placeholder="O que você aprendeu?">
      </textarea>
    </div>

    <div class="field col-12 mb-3">
      <label for="tags" class="font-bold block mb-2">Tags (separadas por vírgula)</label>
      <span class="p-input-icon-left">
        <i class="pi pi-tag"></i>
        <input 
          id="tags"
          pInputText 
          [(ngModel)]="newEntry().tags"
          (ngModelChange)="updateField('tags', $event)"
          placeholder="química, física, biologia">
      </span>
    </div>

  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-end gap-2">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        (onClick)="closeDialog()"
        severity="secondary"
        [text]="true">
      </p-button>
      <p-button 
        [label]="editingId() ? 'Atualizar' : 'Salvar'"
        icon="pi pi-check" 
        (onClick)="editingId() ? updateEntry() : saveEntry()">
      </p-button>
    </div>
  </ng-template>

</p-dialog>

    <div class="grid">
      @if (getFilteredEntries().length === 0) {
        <div class="col-12">
          <p-card>
            <div class="text-center py-4 md:py-6">
              <i class="pi pi-book text-5xl md:text-6xl text-400 mb-3"></i>
              <h3 class="text-lg md:text-xl font-semibold mb-2">Nenhuma entrada encontrada</h3>
              <p class="text-sm md:text-base text-color-secondary">Comece criando seu primeiro experimento!</p>
            </div>
          </p-card>
        </div>
      } @else {
        @for (entry of getFilteredEntries(); track entry.id) {
          <div class="col-12">
            <p-card styleClass="entry-card">
              <ng-template pTemplate="header">
                <div class="flex flex-column md:flex-row justify-content-between align-items-start md:align-items-center px-3 pt-3 gap-2">
                  <h2 class="text-lg md:text-2xl font-bold m-0 line-height-3">{{ entry.title }}</h2>
                  <div class="flex gap-2">
                    <p-button 
                      icon="pi pi-pencil" 
                      (onClick)="startEdit(entry)"
                      [rounded]="true"
                      severity="info"
                      [text]="true"
                      size="small"
                      styleClass="p-button-sm">
                    </p-button>
                    <p-button 
                      icon="pi pi-trash" 
                      (onClick)="confirmDelete(entry.id)"
                      [rounded]="true"
                      severity="danger"
                      [text]="true"
                      size="small"
                      styleClass="p-button-sm">
                    </p-button>
                  </div>
                </div>
              </ng-template>

              <div class="flex flex-column sm:flex-row align-items-start sm:align-items-center gap-2 sm:gap-3 mb-3 flex-wrap">
                <p-chip 
                  [label]="formatDate(entry.date)" 
                  icon="pi pi-calendar"
                  styleClass="text-xs md:text-sm">
                </p-chip>
                @if (entry.tags) {
                  <div class="flex gap-2 flex-wrap">
                    @for (tag of getTagArray(entry.tags); track tag; let i = $index) {
                      <p-tag 
                        [value]="tag" 
                        [severity]="getSeverityForTag(i)"
                        styleClass="text-xs md:text-sm">
                      </p-tag>
                    }
                  </div>
                }
              </div>

              @if (entry.materials) {
                <div class="mb-3">
                  <h4 class="font-semibold mb-2 text-sm md:text-base">
                    <i class="pi pi-box mr-2"></i>Materiais:
                  </h4>
                  <p class="text-color-secondary text-sm md:text-base line-height-3">{{ entry.materials }}</p>
                </div>
                <p-divider></p-divider>
              }

              <div class="mb-3">
                <h4 class="font-semibold mb-2 text-sm md:text-base">
                  <i class="pi pi-list mr-2"></i>Procedimento e Resultados:
                </h4>
                <p class="white-space-pre-wrap line-height-3 text-sm md:text-base">{{ entry.content }}</p>
              </div>

              @if (entry.observations) {
                <p-divider></p-divider>
                <p-panel 
                  header="Observações e Conclusões" 
                  [toggleable]="true"
                  styleClass="observation-panel">
                  <p class="white-space-pre-wrap line-height-3 m-0 text-sm md:text-base">{{ entry.observations }}</p>
                </p-panel>
              }
            </p-card>
          </div>
        }
      }
    </div>
  </div>
</div>